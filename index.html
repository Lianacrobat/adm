<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tienda Minimalista</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-800">
  <div class="min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto flex justify-between items-center px-6 py-4">
        <h1 class="text-2xl font-bold text-blue-600">Tienda ADM</h1>
        <input id="search-input" type="text"
          class="p-2 w-64 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          placeholder="Buscar productos...">
        <button id="cart-toggle-btn" class="ml-4 flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg">
          Carrito (<span id="cart-count">0</span>)
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-6 py-8 flex gap-6">
      <!-- Sidebar: Categories -->
      <aside class="w-1/4 bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Categorías</h2>
        <ul id="categories-container" class="space-y-3"></ul>
      </aside>

      <!-- Product Grid -->
      <section class="w-3/4">
        <div id="content-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Productos dinámicos -->
        </div>
      </section>
    </main>

    <!-- Shopping Cart -->
    <div id="cart-container"
      class="fixed right-0 top-0 w-full sm:w-1/3 h-full bg-white shadow-lg p-6 transform translate-x-full transition-transform duration-300">
      <h2 class="text-xl font-semibold mb-6 flex justify-between items-center">
        Carrito de Compras
        <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800 transition">
          &times;
        </button>
      </h2>
      <ul id="cart-items" class="space-y-4"></ul>
      <div class="mt-6">
        <button id="checkout-btn" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
          Pagar
        </button>
      </div>
    </div>
  </div>

  <script>
    const apiKey = 'AIzaSyBMoIDX2lOzmzKLH-mxvj4sW3Z1kt2SqIM';
    const spreadsheetId = '1tW-vqejQ234NMwV4-PxkX0wBgnEfU7Fo5NoW4H7MTfc';
    const range = 'ADM!A1:K';

    const categories = {};
    let cachedData = [];
    const cart = [];

    const searchInput = document.getElementById('search-input');
    const cartContainer = document.getElementById('cart-container');
    const cartToggleBtn = document.getElementById('cart-toggle-btn');
    const closeCartBtn = document.getElementById('close-cart-btn');
    const checkoutBtn = document.getElementById('checkout-btn');

    const fetchProducts = async () => {
      try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`);
        const { values } = await response.json();
        if (values) {
          cachedData = values.slice(1);
          processSheetData(cachedData);
          renderCategories();
          renderProducts(cachedData);
        }
      } catch (error) {
        console.error('Error al cargar los productos:', error);
      }
    };

    const processSheetData = (data) => {
      data.forEach(row => {
        const [category, nameCategory, , subcategory, idSubcategory] = row;

        if (!categories[category]) {
          categories[category] = { name: nameCategory, count: 0, subcategories: {} };
        }
        categories[category].count++;

        if (!categories[category].subcategories[subcategory]) {
          categories[category].subcategories[subcategory] = { count: 0, id: idSubcategory };
        }
        categories[category].subcategories[subcategory].count++;
      });
    };

    const renderCategories = () => {
      const container = document.getElementById('categories-container');
      container.innerHTML = Object.entries(categories).map(([key, value]) => `
        <li>
          <div class="flex justify-between items-center text-gray-800 font-semibold py-2 px-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100"
               data-category="${key}">
            <span>${value.name} (${value.count})</span>
          </div>
          <ul class="ml-4 mt-2 space-y-1">
            ${Object.entries(value.subcategories).map(([subKey, subValue]) => `
              <li>
                <div class="text-sm text-gray-600 hover:text-gray-800 cursor-pointer"
                     data-subcategory="${subValue.id}">
                  ${subKey} (${subValue.count})
                </div>
              </li>
            `).join('')}
          </ul>
        </li>
      `).join('');
      attachCategoryListeners();
    };

    const attachCategoryListeners = () => {
      document.querySelectorAll('[data-category]').forEach(element => {
        element.addEventListener('click', () => filterByCategory(element.dataset.category));
      });
      document.querySelectorAll('[data-subcategory]').forEach(element => {
        element.addEventListener('click', () => filterBySubcategory(element.dataset.subcategory));
      });
    };

    const renderProducts = (data) => {
      const container = document.getElementById('content-container');
      container.innerHTML = data.map(row => {
        const [, , , , , , , name, image, description] = row;
        return `
          <div class="bg-white rounded-lg shadow hover:shadow-lg overflow-hidden transform hover:-translate-y-1 transition">
            <img src="${image}" alt="${name}" class="w-full h-48 object-cover">
            <div class="p-4 flex flex-col">
              <h3 class="text-lg font-semibold text-gray-800">${name}</h3>
              <p class="text-sm text-gray-600 mt-2">${description}</p>
              <button class="mt-4 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                      data-name="${name}" data-image="${image}" data-description="${description}">
                Agregar al Carrito
              </button>
            </div>
          </div>
        `;
      }).join('');
      attachAddToCartListeners();
    };

    const attachAddToCartListeners = () => {
      document.querySelectorAll('[data-name]').forEach(button => {
        button.addEventListener('click', () => addToCart(
          button.dataset.name,
          button.dataset.image,
          button.dataset.description
        ));
      });
    };

    const addToCart = (name, image, description) => {
      const existingItem = cart.find(item => item.name === name);
      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({ name, image, description, quantity: 1 });
      }
      updateCartCount();
      renderCart();
    };

    const renderCart = () => {
      const container = document.getElementById('cart-items');
      container.innerHTML = cart.map(item => `
        <li class="flex items-center gap-4 py-4 border-b border-gray-200">
          <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md shadow-md">
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-900">${item.name}</h3>
            <p class="text-sm text-gray-600 mt-1">${item.description}</p>
            <div class="flex items-center gap-2 mt-2">
              <button class="quantity-btn" data-name="${item.name}" data-change="-1">-</button>
              <input type="number" class="quantity-input w-16 text-center border rounded-lg"data-name="${item.name}" value="${item.quantity}" min="1">
              <button class="quantity-btn" data-name="${item.name}" data-change="1">+</button>
              <button class="remove-btn" data-name="${item.name}">Eliminar</button>
            </div>
          </div>
        </li>
      `).join('');
      attachCartListeners();
    };

    const attachCartListeners = () => {
      document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', () => updateQuantity(button.dataset.name, parseInt(button.dataset.change, 10)));
      });
      document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', () => removeFromCart(button.dataset.name));
      });
    };

    const updateQuantity = (name, change) => {
      const item = cart.find(item => item.name === name);
      if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
          removeFromCart(name);
        } else {
          renderCart();
        }
      }
    };

    const removeFromCart = (name) => {
      const index = cart.findIndex(item => item.name === name);
      if (index > -1) cart.splice(index, 1);
      updateCartCount();
      renderCart();
    };

    const updateCartCount = () => {
      document.getElementById('cart-count').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    };

    const filterByCategory = (category) => {
      const filteredData = cachedData.filter(row => row[0] === category);
      renderProducts(filteredData);
    };

    const filterBySubcategory = (subcategoryId) => {
      const filteredData = cachedData.filter(row => row[4] === subcategoryId);
      renderProducts(filteredData);
    };

    const toggleCart = () => {
      cartContainer.classList.toggle('translate-x-full');
    };

    cartToggleBtn.addEventListener('click', toggleCart);
    closeCartBtn.addEventListener('click', toggleCart);
    checkoutBtn.addEventListener('click', () => {
      alert('Gracias por tu compra!');
      cart.length = 0;
      updateCartCount();
      renderCart();
      toggleCart();
    });

    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      const filteredData = cachedData.filter(row => row[7].toLowerCase().includes(query));
      renderProducts(filteredData);
    });

    fetchProducts();
  </script>
</body>

</html>
